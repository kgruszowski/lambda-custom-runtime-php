<?php

function add_watermark($data, $sharedRandom)
{
    $s3 = new \Aws\S3\S3Client([
        'region'  => 'eu-central-1',
        'version' => 'latest',
    ]);

    if (!isset($data['Records'])) {
        throw new \Exception("Not a S3 Event");
    }

    $key = $data['Records'][0]['s3']['object']['key'];
    $path = explode('/', $key);

    $result = $s3->getObject([
        'Bucket' => $data['Records'][0]['s3']['bucket']['name'],
        'Key' => $data['Records'][0]['s3']['object']['key'],
        'SaveAs' => '/tmp/'.$path[1]
    ]);

    $image = imagecreatefromjpeg('/tmp/'.$path[1]);
    $watermark = imagecreatefromstring(base64_decode('iVBORw0KGgoAAAANSUhEUgAAASwAAAA2CAYAAAB9R6Q8AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAb6ElEQVR4nO2de7QdZZnmf8+Zs05nZVh0JpNmWFnIpCNqgMiu7xMRQVERUbkIg4gKAdFuQARURIbGNLLURkVUWqFFRm6KSgOCiIAMIDLcVC711UZExMBkGBak02maxbCYdBaTZ/6oSnIue5+qfc4+J1z2b62zcnL2V1+9Vbvqu77v84oeCCGbI7Gn7XdKisBiYL7tYUlrbVaDV0jKgV8Cd+Z58UIv5xgwYMCAbqhJoRBa20o6yfYREvNA2EYqD9/wuw1gQJQfeY2tS8DfSqn9xAxdw4ABA14hTNpghZDNBZ8GfFrSHBukskFq2GBRHsNa0Lm2v5BS+7mZvaQBo4kxmw9sZbMmpWLN5rZnwIDp0LXBijFbClwJXlI2OmIaDdaGYx4DfTCl4r6ZvrCZJsZsV2BReb3Q5Vbel+fFilkzahQxtva2+YKkXTd8L5LuA07P8+KGyY4NIUPywaDhDd9nh+tcZ3N1SsVMXcKAVxAhZCMSB21qSzq2Ly8Mdzo4xmwv21dJ2rLPdi2WuCPG7PA8L37S57pnm5PBB41+mTfdZFeNNycDX59tw2LMPmP7Gx0+2tn29SG0lqfU/nK34yVGbF25oXMa2/FsvM51En82Ixcw4BWHxHzbl43966bBz4bnb2j8gTFmewE/B/rdWG1gDnBZCK1DZqj+VzQhtN4OnNXt86rROSOE1j6zZNKAAX1jTIMVQmuJ7asoG5WZZBi4NMbsLTN8nlcip9GhIxqPpNNnwZYBA/rKxge7dFnQlczcyGo8I7YvD6G1YJbO97KncjvZo2HxXaoF+QEDXjJsbLAkTgWWzvL5F0rqtNYyYApIzKccvTZl0FkMeEkxDBBCayHw2d4O1UO2r5P0e0nrbC+QFGztA2zdQ0XLQmidk1L7Jb9zuLmxWQOskxhpUHw9sHqGTXpZE2M2DJxZOU4zekd1w8468AJwUp4PdlP7wTCApBOBuQ2PecL2cZKuzfP2hA9jzEZsHwE6E2gy5RgCTgXe3/D8A7qQUrEuhNZNwH4Nit+d58UzM23Ty5xh4DMT3Xw2Faj+fjJlBzFgmgyF0Bqx/bFmxV0Ab0ipfW23HiPPi3UptS8AAujhZvXqfTFmvYzKBnTnNGBdTZn1tpfPhjEvc2o3Nwb0lyFJe9FsJLRa0r553m40jcjz4nHb7wLVlX8BfCd4XpN6B0xOSu0C+DDwfJciL4COSql9+yya9TLF9UUG9JUh4F1NCto+Jc+LJ3upPKX2ExIndPjoWeAKSYcB/yml9jvyvN1wNDagjjwvrga1JC4CnmTTetWPgTekVFy0WQ0cMGCKDAM71xfTk8APp3iOnwAPAVuArrX9M0m3p9Sum7YMmAYpFSuAv9rcdgwY0E+GKSVi6rghpanJxOR5sT7GbHfwMylNXKQfMGDAgKYM08AXR+J30znJYDdqwIAB/WCIZo6Gz860IQMGDBhQxzDlbtIWNeWa+mhtdmLM5gLR9g6S/rPNluChUhHVT0l6zCaXvLKTH9ks2AewCNjJ9kJJWwBrba8BPQI8mFLxkl7fizHbAtgJWAxeABoCnrf9pKSHwSvyvD1jfknVPV5qe2fQq0vRSYbAz9s8JekR4J48L17SjrMxZtheIhFB29n+C0lDttdJ+mdgJfAg8GCeF7PmBxZjNgQstr2dpAW2RyStBVbbrJBYOVVH2mHKXaTX1pR7VXfjWktsvgI6VvLWNntJ+sFsPgwxtuaADgYOA95ue442yjZ547/jdHZWxphdDf7ebOxQhtBaJOlY24cAi6SxshmbbOO5GLMbgfOAW3v9YquX9Rul9zVscGrcpFFWYvv0lNp9m6qHkM0BHwocDrwFPNxBkobKG3xNCK0bJF0M3NYvL/AYs4XACbaXSdqmvL+bdLw2eZ+XnughZPdJXAq+KM+7C0vGmC2g9G8bpc1kSr2wemyfXTUupSWb7sOjeV58ewrXuR1wjO1DJG1bnmP8Ocfc+2dCaN0o6fu2b0qp/51FjK1h0H6ULjV72WNdpcbZsyrG1nWg8/O8N208xZj9zPb7JopljdZ20m0pFe/oVEEI2S7giyXtC5xu+8hKCeDbtj8BKiRunIkWvgqN+Diw3PbWox/GsS/r2P+PK7cedA1wSi9iezFmV43Vw5pYN3CypHOBLwGfpAz4ruzZeG/HvdSj7dYtEkflebGyB7uGgP83+jyjBPxG2/bqlNqPdaljxObfOuthbbzOdcCfVaKOHwJ9A7xw7IPZ+b6P/r/teyR9Ks+L3zS9xg72Dtv+G4lTbc0df63dvvtN98drJJ1SNVyd6l8K/p2tjfdxdCcw9v7C2Hs/9vcNtlTf/X0pFW9sep0htBZKnAkcChqa6F0/0bYN9oy6Bw8Cp6bUvq7peSejet6WAV+wvWj0c93kXoGvAI4Fjdh+Crreq1IPy+bX9Wb5LSFk23T6JKXinpTaO1Yv1YkSHwbOBQ6ROAN8PfAPU74jXYgxW2r7XuAc8HS85IeAg2z/LoTsk9UIpV/8R/CvbH8WGsX3jWcv4P4XsQzPMPh8m8uAhVOpQGIX23eF0Dqjevh7IsZsvu1fgr4EmurSxQKbC0GXxZhN5XuacWLMlgF/sFlWTbGnylLQz2PMLqum7tOwqbVNee/5PnjRVOqwOcTWb+1m7/CQxE0Nyg2D39fpgxiz4RizXasX/RnQdXlePA38I+i7oHXAFjFmxJhtN5WHssM5DwZ+C/SzdZkj8S3g4mrk1g8+C9p1mnXMt/2LGLO+tqR94luSju5DPUPA52yu7KXBiDHbkjI7U1NJnTo+VNnwogm5iTEbCqF1NnAp/ZV++pDtu6YaEhdjtrOte4G3T98Ubyfp0iYlh4C8XAjtyAPA3aA1wJ1dyrzP9q9t7wKcCf4/MWa/BebleXGs5P8AfAQ43vafwL+u1hqmRIytI4HL7ZnaCPCRNhf36aHtV8O3he0rY2y9mDY/RoBP9LNCiYMoO4zaslWZi+lvpwXwPuBv+1znlCjXvTgP+PTMnEE72b65avh7sKsVKTuKfsb/NpK2GqoWPEdP2Z6hXIgHWJDn7d1TKv4CWBtC66kYW9+PsbVxQc32DZL2LxMc+H5bT1aN19IYs9eC9rQZAq+gjGPbBbh5KqOYGFv72HwPPKM9oMQy4L/O5DmmwHagz2xuI2YeH2r7k7Wl7APLNcQZsMBeXi1sb27+FtyPEexkLAW+33QpJIRsoc31zJ7Q5xiGAGxfBN7QSM0DviTpEuDwELKtY8zmVGXnAUcAf4wx+2wIrZGU2mvzvLguz4v1ed6+QuJVkv6yysxyue2fS74XtKJcmPfzwOJeR0ghtLa1+RH9G7XU4C/F2HqxTcNOrNw2XtZI+kqMWdcIjOrlOq2uHptVwNdAH7B9gKQTbK6jXuplhDKByGYjhNYe4C80P8LPAQVwN/Bg9Z415UCbD9UVKu+7vw/abMoqwwAptZ+PMTsWuIpSeuTWlNrfDSFbKvl/l74TOsD27sCFoMz2WcDzIWR3gs8BDitzF/pwSTfHmK20fQ7oPHAG3GH7dRKvB0YkFsSYzc3zYlWdkWXaKb5n96zo8DzwGLAWNM9mEc0bvGHQt2LM3tZH8bXVlA/UKmAEtATYpQeb5tveD7iiXwbNAOts7gGtAK+ljKTYkCW8KXOBrwAf7PSh7R2qOifjFon353l7vNPzuSFku4F/CmzV5dhVwP/swd6+EkI2Av4eDeRrbG6SOFPS7aOzrJc7p+wh8SnKaW5dTWfG2Lo6zyeN8V1GuRHUC08DheQ1oBFgO2AHpijNs/FFyfPi2hBar5G0HtgyxtbWtp8D1gJLgHslfdj2G8DvkfRm4GqbrcuTC8pg27+x+bzEraBjJL8NuKp04GROnrcfizHbw/avKKeZ70ipfc/kZnof0N7NLknrJV9Rzf3vTqk9+kvcsvQV8XLKm1bHHrb3AKYrxbLG9qckrhhtT2lTa2EldrisYV378uJssJ6hHJlfND4UK8YMSdH2aRIHNqzv4Biz7bq4mtQtsq8FDuvQWAGQUnF3jNkBtu9i04vzAnAD+EJJN4x++YEnQKds2pYvkfj3wOfrL0WnsnFUt8kNQaJbNvSPU+8b+QJwjMRFnTrUyv5bgVtjzA4FX8wkO9US24I+BPyg0+cxtkYo3XOacjfwJdu3jH/mQ8i2tjla4mTqndbH2jnRsGw74I+Vb8p7gSHbV0paBL7OZv/KWe3x8TcqhGxL4BTgkxJbgJ8Gvc72OtAcid1sv1fSo7bPBJBUAG+YzE8rhNavy4Sgm3yqRvt5jJKkXQV8MM+LSRuYShX1HODobn5C1b/rbS9Pqf3VDnU08cNCYo3N7im1H5nEHoCzbX+6k7PnOF+eR1Jqv26SumbLD2tjedu5pAPyvOj2Ao6+zo8B53uUrPBon6hN9x9sfy2l9inj6wmh9Q3gM53vFYCLlNphMluqen4qaYnNhRI/bDLaH3c984B/rfPDkvTvmvohlmu7ftRm29EN5ESfLj6aUnFJU1tDaB0t6fzuPlHG5s6U2m/tcvyhkn5Uc/wG206X/Hd10QwhtBZL/NxmhwY+a53zEpaNDKsph8v/A3hB0o62PwA6TuKvgf9l+08htN4eQmtOjNk+MWZDKRXPplQsl7wjcINdisil1H4WeNb25dU2+F9R9hAAWTXN6Ui5nV/vGlA2DH5bXWMFpSqqpGMk/rFLkftsnWT7Lzs1Vr2hEyZrrCp7AE6WmLQcgMTiEPrmdjFtbD8i6Z11jRWU15nnxUXgThppHdDBnRaDpdo0dNtWI4LJay/12LZPqfh6r43VTGGzN7BtTbHrJC7ppV5J/w2o8yrfLYSs2zS5kVSR7S+mVHyxSehV2WHqHZQhRI2Y0GDleftp4J3ACsrh2iJgbanhXjwOug94mHIuulTSPravt73zqDoez/Ni35TarwKyGFv/KnEZsKYq8lrGrtsc191Ed1zHmIg+WtcwjCbPC2wdO8qmB4DloFfnefHGlIpvptR+vGl9HS0Sj9Nw+lYO4XVeg6LDUte1l9lmvaTDe1fj0HeBG+vLebHtCbt1dm0w/nzQeXWNVp4Xz7/YkkNI9bkNbJ/Zq91V+Qtrig1JE/2qQsjmq0H6OInfgHrYKIAqhO+jTct3XPjK8+KhalT1mjwvrqm8Wf85xuwM8EM220v6c0nn2r4WtDuo4zqUzbsodxcPpKs3tPbq1rJXPU4Nug3oOdQgpeIZyuQX26fUbuV58eU8LzpOk6aCza29hCTZvqVh0RfLTuE1eV7UrD9OJM8LJBomcu04uv5DgwM/BjwaQnZOjNmhMba263MUQ9+p7Jt0UVviGUl3T/EUTcKfJoQKSexhN9kY0ukp9R6CJ+k2yvW2WroakefFOspRFpS7bVvafE7SHRIP2OwqcUNK7bWUC2xdjPFV1Ps0DUnsRSnhu5EYszm2d6q7CJvzU5paT5nnM6pt/miP5R/rsKzYiReLJ/bFUz9U9wCPUL+4/PoOf7u1jAGtvQ/bgI8Hjq/Wup6OMbsPuAd8F+j2PC962f6fUWxvtSGYuXsZYKPf1Kb1vur48QH+Yz6jWUe3pINdTeIdnwCadrhjyPOCGLOLgT3ryjZcC9EBtg+ubuZt4H8APmbzxRCyn4MvBA5Iqb1y/JE290g8Ru22tt/MuAbLnjB17Gyd3CS8aHOwtpfCpQSH108zVmy2WG9z21QPzvOCELLbpMkbLIlF4/+WUvuJUn2AfXo87Xxgb/De1YLx8zFm19k+J6V2t0iO2aSu8QaYVzk2j1NAGFtonDoCatQPAtApZrjWrkogYcoCB/Y0R1ijqeSRNy5Qx5idIfGo7SvAw8DjoI4vZ0ptYsx+Q70fzoSWnc43bzxPVOtuA2aXx1MqukqyNEFqNLXrpoh7KuX0aTrBynOBQ4BDQshulDiun0sCU2DKIWt9pJOvYxO7fj+dk0o8Wa1NTupBP6XdpupL/fKoP+1fc0jt4rXd6aa4ifv/S1qE7SVMP+77mvoinacxKbUfCKF1chWw3g/eA6QQWof1S3qldzQt9YQ+0WkHtvY9lKb3PJQj7taaunPN1tTj/9YVKP22JtDEviklxxgwbfqhbzatOiR9m9Lvr19aa1uCfhpj1iRz9suVqb5Ps6JoOlsN1p/XFbA7ZStWkwXRQQLWzUOT5Lv9qKPrM1D5dX1N0rvB/ZrKDdv+UYzZoj7V1wM9xf/NFJ2m+bV22Z6V56F2ShhCNiQxN8+ns17hpXW7XxIT1qEkVo1fTOzAohizkWpXc8DssSiEbGSa+vOvblCmdtqY58UtMWbbA0dIHGdPW3JmS+As4APTrKdXap1XJR6yuVEauyPYIWyoYnS50R7zY48p/xV0jqFsMN3Ta+rLdKd0a6qPFe7YYFXqDHsCB4D3s/Ug8O6pGdKaRzOBtQkxY7abOIKO2N6V6cf7DeiNEYnp3vdaJVWbRiOnqsO6ALggxtZ2wN6lf6B3g4k7jQ04KMZs29JZenaodtPreDyl4qQZN2YstXZJ3m06J5B4S4PByaYGK8ZsK2Af2wcAe9neYpTu8sIQWrum1O5Zd1vSJ8B1oRQA94//Q0rtp0No1bpESDqcKb44Mba2AN1v+1bQlRJjot4HTMphTP2+L6ZecQFNISdmnrdXUHaA3ynPlS20vZvE7pSL6512pMczBOy3oY5Z4nFKdYOuUyObXWNsjdSoKvQVScn1rclOIWRLUiqmmtDlw00KDcWY7RZjdhfwFKUj4IF0iKCWdHGvyoQhtHawvbxZaXVzOmvgn+Flk+kn1bAhMv7jEr8EPxVCdn4I2V5lJpABk3BEjFld3FtHbE6mmXxKY6/uELKhTsKQeV48mVL7J3nePhHYHrQvDaaaNrUB1P2kSoBR1wHMs5kR4cJJuL2JQ3OlvtAzIbR2gGYqHkPAWpvdqH94llTa4o0W12LMFktcTyPvWj9MGcvXAV3V4HRzbF/cJOB1NFUjN14IboHE0ZJvBj0VY3Zhrw31K4g5Nhf3GowdY+stwF83KPqw1D0wNsZsfozZe2LMvhBC9t8l/sX2pLLN1UL9DZKaxK/1JWbT7mmD4md1BSSdMZUEEjG2RkJo9dyxl25MfqiunO0jQ2jVequPtSkboYxxbPQMDZXSILVR3BXaDZxCyA7qpnkeYzYUY2sZcC/N1w7O6xbMWSbJ8MoGdewBXN5UkTPGbBvbv2Byv48Ftg+0e/NYfyUhsSelDnujziKELAP9lGYP6GXjn4sYs51DyC4NofVH8L8Av7D9eWBvyh3jfRua3sSzum6rvtFWfhV21pSrQXUbXIuBy3rtoEFnAX8KIbu+auh78RJokiRiSNKVIbRqp/pQChXavhRonKhlKKU2wBlNDwC2lbiqkpc5J8bs6Bizg0NoHRFj9g3bf7J1Kc23vVdLXNTtwyp4+KxmVelA4P4Qsvd0C3SNsTUcQrYMfD8NQg4k/fClnol55vEy4I4Qsp27lah6909K3EF37/XRrJPU6blYVIWmdPnutHeMrbc3qL/JVPbJms+fo4Hfku2zQshqY2IB8rx4Frq/D6PYz+bmGFu11xFjNhJCdjZlbswhYB/Khv73IbQ+0WS0JnEBnV0exjNf0h0xZp+erBOLMdtZ4i7KSIPGDAPYXCNxG72l7Fks6fjy+A1bp72ceiPLJ8u6CyDpAuAEGi2WegnwC5vHYsxutP1HSc8BW9re0WYfqXEIxDrw2Q3LvtLZRfK9IWS/AW4C/0Finc18SW90max36/EBu5Pwgy4aW7dRNhJdR2hVqq79uyVnjTEbst1APdP3TvZpnhfrY8xWUP9cbiORQmjloJVV4PZ8m9UpFYd1sP8rEkdS72G+h60/xJhdBL4UyPN8tMJuayGwn+0TJZZMvO9aUsUFnxFjdonNGSkVHdf28ry9Jsbs28DnamwCPNfW2eBTY8yusX0/aI3EiO3XUnocTGlXsdJ0LwihdZSkRI+SpdPkVhr0JnlerAshOwr4FQ3nuhKLqdJQTfRBacw383xiQPeAyfCulbvDmADcnmowz0idk0zkebEmxuxamHTheQFwR4zZD4EfgR+w9QwwD7wr+CTqXW3WSbqhga1303zXcWfJO49Sqe24FJNSsSqEbLnkc+oqlZgLHG/rePDaGLMnbL8AWsDGkWztMz/P9scknVlT7ivAoTRf6tkKGJf1Z8O1T42Nc9iU2isoVQVnxcUeeBJ0eFO9qJSKO2mQKaVf2DwI9CRGNqBf+FOTKYBWo6O652YYfKTtm4F/kvg38D9J+hnN/AKvqMTlJkXi8gZ19YzEd0C9xjTOoRTWXEKzafdoTq5TXc3z4jmJw9mM4XBjFt3yvLiCMjZrpnkGtG9KRd0awRgkvirx3ZkyahRrJP2XPC8Gi+3dmZGOzdZ3JHVMhLCBlNoF6O9n4vwAEs/RsHO0uYV66eGeyfNivc1hZb7PGecHlYRyLXnevhN87Ewb1I0JuwQptb9u8ylm7IFkNfCulIqeFfdKPxUdB/pm/y3bgNYA7+6SrWXAJlYA1/azQpsfSpzQUP73VKYoGFePjsnzYmWTkqUGlI+hR+2zhnU/a/NuJhHI7APXAEf1IrmcUvsCSlnzfrYROQ1Ckzpua6ZUfFtiX/ou3aJ7JL8pz4sp9xplwtbiJPBHaLZr0QsPAG/O8yLvc70vU3wY0A/hu/XA30l8pIclgnWgA4Dadabe7PAJeV78uL7oaFvaOXA4dArgnx4pFU9LeifQaATUG/57SR+YShxunhffkXwATIwB7h09YfN+Gty/rn4Yed6+Efx64BKm35I+Z3OqxO79WsROqf0DYEebn/ShurXAl8FvGoysmlPt7r6LMnxlqs/Ig5LekVL7tF7078vzF88D+1Pm/ZvuCOdJm/1Tap87lYNTav+E8l70XQAwz4u1eV4cQ7m7VuvA2YDHgPem1D5xOmFoed6+DtgR+DFoqt//3eA3p9RsRDup41iet1fnefujkl5vN/bD2IjNaklfBb06peKr/Y7RS6n9eErFB0CBsmHtccSlNba+CbwmpfbyPG/38tCvoRyBrgat3vT7mJ+67C6deGLD8ZUo2pifako9iZ2G0n9o4zFj69loa9fezGb9+Do6/KyC8mVKqX0c8CbQNaAGfkmspwxB+TCo1SQ1WzfyvFifUvFV8OuAcykTuvbCKtDpEtunVExrtJbnxe02O0o6hjLhQ9eXuEqB19PoNKX2TZJaNh8Ebq/cI3qhAI6SvH2eFw2yFjWyaVWeF4eBW9U6WNMR10Pgj4LemlJ7g/vKmGeuetarH68Gnuhp0zmE1lxJe4LfAcooPW4X2J4jaR1lhuMV1ULhzcBtsxlIHEJrTmkfb7W9k6RFlU7PSKmXztNl9L8LSb8C7hwEOveXGFsLQHvavBHYVvK8qvd92vbjVSDtbSm1Z0QpNoRsTpWq6m3gnaqEpAtAI7bXSXoavNJWAf7l+BTv/STGbJ7tpcA2kubafkHiaVsrJR6e7nmroO69yyzs3sFmoaQtK9ed56rEwo8A99q+qZc0eNOwaRjYBdjV9uskbWV7LqWbyCrbv6uy5DwwlRRr/x/NnzKPiV9JWgAAAABJRU5ErkJggg=='));
    imagecopy($image, $watermark, 10, 10, 0, 0, imagesx($watermark), imagesy($watermark));

    ob_start();
    imagejpeg($image);
    $image_contents = ob_get_clean();

    $result = $s3->putObject([
        'ContentType' => $result['ContentType'],
        'Bucket' => $data['Records'][0]['s3']['bucket']['name'],
        'Key' => "watermarked/".$path[1],
        'Body' => $image_contents
    ]);

    print sprintf("Random number initialized in the runtime: %d", $sharedRandom).PHP_EOL;

    return 'Watermark added';
}
